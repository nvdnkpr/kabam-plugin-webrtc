<style type="text/css">
  #call-container {
    margin-top: 20px;
  }

  #remote-video-container {
    width: 400px;
    height: 300px;
    float: left;
    -webkit-transition: 1s;
  }

  #left-bar{
    margin-left: 20px;
    width: 220px;
    height: 380px;
    float: left;
    position: relative;
  }

  #chat-tools {
    position: absolute;
    height: 200px;
    bottom: 0px;
  }

  #chat-content {
    height: 150px;
    overflow-y: auto;
  }
</style>

<div class="span12" ng-controller='roomController'>
  <div id="call-container">
    <div id="start-broadcasting"></div>
    
    <div id="remote-video-container"></div>
    
    <table id="rooms-list"></table>
    
    <div id="left-bar">

      <div id="local-video-container"></div>  
    
      <div id="chat-tools">
        <div id="chat">
          <ul id="chat-content">
            <li ng-repeat="message in messages">
              {{message.user}}: {{message.content}}
            </li>
          </ul>  
        </div>

        <input type="text" ng-model="chatMessage"></input>
        <br/>
        <button class="btn" ng-click="sendMessage()">Send message</button>
      </div>
    </div>
  </div>
</div>

<script src="/webrtc/PeerConnection.js"></script>

<script>
  var remoteVideoContainer = document.getElementById('remote-video-container');
  var localVideoContainer = document.getElementById('local-video-container');

  var socket = io.connect('');
  var roomId = "[[ roomId ]]";
  var userId;
  var roomsList = document.getElementById('rooms-list');
  
    
  // ANGULAR CONTROLLER
  function roomController($scope,$http){
    $scope.messages = [];
           
    $scope.sendMessage = function() {
      //console.log($scope.chatMessage);
      socket.emit('chat:newMessage', {content: $scope.chatMessage});
      $scope.chatMessage = "";
    }
    
    $scope.startBroadcasting = function() {
      peer.startBroadcasting();
    }  
  
    socket.on('chat:newMessage', function(data){
      //console.log(data);
      $scope.messages.push(data);
      $scope.$apply();
    });

    // partner disconnect
    socket.on('chat:disconnect', function(data){
      //console.log(data);
      if (roomId == data.roomid) {
        $('#' + data.userid).remove();
        $scope.messages.push(data);
        $scope.$apply();
      }
    });

  }
  
  // CHAT - CALLING
  socket.on('connect', function () {
    //console.log('connect');
    socket.emit('chat:joinRoom', roomId);
    
    socket.on('chat:id', function(id){
      userId = id;

      var peer = new PeerConnection({socketEvent: 'chat:video', roomid: roomId, socket: socket, userid: id});
        
      // Video 1-1
      
      peer.onStreamAdded = function(e) {
          //if (e.type == 'local') document.querySelector('#start-broadcasting').disabled = false;
          var video = e.mediaElement;
          video.setAttribute('width', '100%');
          video.setAttribute('controls', false);

          if (e.type == 'local'){                                          
            localVideoContainer.insertBefore(video);
          } else {
            remoteVideoContainer.insertBefore(video);
          }
                
          video.play();
          //rotateVideo(video);
          //scaleVideos();
      };
      
      peer.onUserFound = function(userid) {
        if (document.getElementById(userid)) return;
        var tr = document.createElement('tr');
        tr.id = userid;
        
        var td1 = document.createElement('td');
        
    
        //td1.innerHTML = userid;
    
        tr.appendChild(td1);
        peer.sendParticipationRequest(userid);
        
        //roomsList.appendChild(tr);
      };
    
      // Auto broadcasting
      (function startBroadcast(){
        if (peer.startBroadcasting) peer.startBroadcasting();
        else setTimeout(startBroadcast, 1000);
      })();      
    });     
      
  });  
</script>