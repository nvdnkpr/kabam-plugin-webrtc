<html ng-app>

<head>
  <title>Calling RTC</title>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/assets/call/notification.js"></script>
</head>

<body>
  <div id="flash"></div>
  <div ng-controller="userController">
    [[^user]]
    <a href="/home#/login" class="btn">Sign In To Call</a>
    [[/user]] [[#user]]
    <button class="btn" ng-click="call('[[username]]')">Call [[username]]</button>

    <button class="btn" ng-click="leaveMessage('[[username]]')">Leave a voice message for [[username]]</button>

    <div ng-show="showRecording">
      <div style="clear:both;">
        <video id="preview"></video>
      </div>

      <button class="btn" id="btn-record" ng-click="record()">Recording</button>

      <button class="btn" id="btn-stop" ng-click="stopRecord()">Stop Recording</button>

    </div>
    [[/user]]
  </div>
</body>

</html>

<script src="/assets/call/RecordRTC.js"></script>

<script>
var _csrf = '[[ csrf ]]';
var homeOwner = '[[username]]';
var localStream;

var videoPreview = document.getElementById('preview');
var video_constraints = {
  mandatory: {},
  optional: []
};

var recordAudio, recordVideo;

function userController($scope, $http) {
  $scope.showRecording = false;

  $scope.call = function(username) {
    $http.get('/call/call/' + username)
      .success(function(data) {
        window.open("/call/room/" + data);
      });
  }

  $scope.leaveMessage = function(username) {
    $scope.showRecording = true;
  }

  // Do recording
  $scope.record = function() {
    // Get media and record
    navigator.getUserMedia({
        audio: true,
        video: video_constraints
      },
      function(stream) {
        localStream = stream;
        videoPreview.src = window.URL.createObjectURL(stream);
        videoPreview.play();

        recordAudio = RecordRTC(stream, {});
        recordVideo = RecordRTC(stream, {
          type: 'video'
        });

        recordAudio.startRecording();
        recordVideo.startRecording();
      },
      function(error) {}
    );
  }

  // Stop recording
  $scope.stopRecord = function() {
    recordAudio.stopRecording();
    recordVideo.stopRecording();

    $scope.saveRecord(recordAudio.getBlob(), recordVideo.getBlob());

    videoPreview.src = "";

    localStream.stop();
  }

  // Save record to server
  $scope.saveRecord = function(audioBlob, videoBlob) {
    var formData = new FormData();
    formData.append('audio', audioBlob);
    formData.append('video', videoBlob);
    //formData.append('_csrf', _csrf);


    $http({
      method: 'POST',
      url: '/api/recordings/' + homeOwner,
      data: formData,
      transformRequest: angular.identity,
      headers: {
        'Content-Type': undefined
      }
    })
      .success(function(data) {
        console.log(data);
      });
  }
}
</script>